<!DOCTYPE html>
<html>
<head>
  <title>US State Map – Micromobility Policy</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;font-family:Arial,sans-serif;color:#142b59}
    #map-wrapper{display:flex;flex-direction:column;height:100vh;width:95%;margin:0 auto;padding:10px;border:5px solid #ccc;box-shadow:0 4px 10px rgba(0,0,0,.3);background:#fff}
    .info.legend{background:#142b59;color:#fff;padding:12px 16px;font:16px/20px Arial,sans-serif;box-shadow:0 2px 10px rgba(0,0,0,.2);border-radius:8px;max-width:90vw}
    .info.legend i{width:20px;height:20px;display:inline-block;margin-right:10px;margin-bottom:5px;vertical-align:middle;border-radius:3px}
    @media(max-width:600px){.info.legend{font:14px/18px Arial,sans-serif;padding:8px 12px;max-width:85vw}}
    .leaflet-popup-content a{color:#00539b;font-weight:bold;text-decoration:underline}
    .leaflet-popup-content a:hover{color:#ec1f2f}
    .leaflet-tooltip.state-label{font-size:7px;font-weight:bold;color:#333;background:transparent;border:none;box-shadow:none;text-shadow:1px 1px 2px #fff;pointer-events:none}
  </style>
</head>

<body>
<div id="map-wrapper">
  <div style="text-align:center;font-size:35px;font-weight:bold;margin-bottom:10px;">Micromobility Regulations in United States</div>

  <!-- top controls -->
  <div id="logos" style="display:flex;justify-content:space-between;flex-wrap:wrap;align-items:center;padding:10px 20px;">
    <img src="logo-funder.jpg" alt="Funder Logo" style="height:80px;width:200px;object-fit:contain;padding:5px">
    <div style="display:flex;gap:20px;flex-wrap:wrap;">
      <div style="border:2px solid #ccc;border-radius:10px;padding:12px 16px;background:#fafafa;width:250px">
        <label for="mode-select" style="font:16px Arial;font-weight:bold;margin-bottom:6px;display:block">Mode</label>
        <select id="mode-select" style="padding:12px 16px;font-size:16px;border-radius:8px;border:1px solid #ccc;background:#f9f9f9;width:100%">
          <option value="E-bike">E-bike</option>
          <option value="E-scooter">E-scooter</option>
          <option value="Conventional bicycle">Conventional bicycle</option>
          <option value="Moped">Moped</option>
          <option value="Other wheeled modes">Other wheeled modes</option>
        </select>
      </div>
      <div style="border:2px solid #ccc;border-radius:10px;padding:12px 16px;background:#fafafa;width:250px">
        <label for="variable-select" style="font:16px Arial;font-weight:bold;margin-bottom:6px;display:block">Variable</label>
        <select id="variable-select" style="padding:12px 16px;font-size:16px;border-radius:8px;border:1px solid #ccc;background:#f9f9f9;width:100%"></select>
      </div>
    </div>
    <img src="logo-UTK.png" alt="University Logo" style="height:95px;width:200px;object-fit:contain;padding:5px">
  </div>

  <div style="text-align:center;margin-bottom:10px;">
    <button id="toggle-city-list" style="background:#142b59;color:#fff;padding:8px 16px;border:none;border-radius:5px;font-size:16px;cursor:pointer">Show/Hide City List</button>
  </div>

  <div id="city-list" style="display:none;text-align:center;margin-bottom:10px;font-size:16px;color:#142b59"></div>
  <div id="map" style="flex-grow:1;min-height:60vh"></div>

  <div id="footer" style="text-align:center;padding:10px;font-size:14px;color:#555">
    <div style="font-weight:bold">Created by the Team at the University of Tennessee, Knoxville</div>
    <div style="font-size:13px;color:#777;margin-top:4px">for Safety of Micromobility: Regulations, Data, and Stakeholders</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="us-states.js"></script>

<script>
/* ===== VARIABLE CONFIG (unchanged) ===== */
const modeVariables = { /* …same as before… */ };
/* legend orders (unchanged) */
const sidewalkOrder=[/* … */], bikeSidewalkOrder=[/* … */], ageLimitOrder=[/* … */],
      helmetBikeOrder=[/* … */], equipmentOrder=[/* … */], accessBikeOrder=[/* … */],
      passingDistanceOrder=['2 ft','3 ft','4 ft','6 ft','Speed-based (3 or 6 ft)','Adjacent lane','Safe distance'];

/* ===== MAP INIT / DATA LOAD (unchanged) ===== */
const map=L.map('map').setView([37.8,-96],4);
map.zoomControl.setPosition('bottomleft');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
/* CSV fetch omitted for brevity—identical to your last version */

const canon=v=>(v??'').trim().replace(/\s+/g,' ').toLowerCase();

/* ===== COLOR LOGIC (ALL BRANCHES RESTORED) ===== */
function getColor(value,variable){
  if(!value||value==='NA'||value==='Mode not defined'){
    if(variable==='Age_limit') value='Regulated at local level'; else return '#cccccc';
  }

  /* E-BIKE */
  if(variable==='Age_Class3_(E-Bike)'){ if(value==='None') return '#ffffb2';
    const n=parseInt(value); return !isNaN(n)&&n>=16?'#1a9641':'#fdae61'; }
  if(variable==='Helmet_Grouped_(E-Bike)'){
    const c={'12 or below':'#a6cee3','14 or below':'#1f78b4','15 or below':'#b2df8a','16 or below':'#33a02c',
             '17 or below':'#fb9a99','18 or below':'#e31a1c','21 or below':'#fdbf6f',
             'Not required':'#cab2d6','Required for all users':'#6a3d9a'};
    return c[value]||'#ccc';
  }
  if(variable==='Sidewalk_Riding_(E-Bike)'){
    const c={'can ride':'#1a9641','partial allowed':'#fdae61','cannot ride certain classes':'#984ea3',
             'cannot ride':'#d73027','cannot ride but can stand and park':'#377eb8'};
    return c[canon(value)]||'#ccc';
  }

  /* E-SCOOTER */
  if(variable==='License_Req_Grouped'){
    const c={'DL not required':'#1a9641','DL or permit required':'#fdae61','DL required':'#d73027','prohibited':'#7570b3'};
    return c[value]||'#ccc';
  }
  if(variable==='Age_limit'){
    let v=canon(value); if(v==='mode not defined') v='regulated at local level';
    const c={'8':'#1a9641','12':'#a6d96a','14':'#fdae61','15':'#f46d43','16':'#d73027',
             'regulated at local level':'#ffffbf','prohibited':'#7570b3'};
    return c[v]||'#ccc';
  }
  if(variable==='Helmet_Requirement'){
    const c={'Not required':'#1a9641','Under 16':'#a6d96a','Under 17':'#fdae61','Under 18':'#f46d43',
             'Under 19':'#d73027','Riders all age':'#66c2a5','Mode prohibited':'#7570b3'};
    return c[value]||'#ccc';
  }

  /* CONVENTIONAL-BIKE */
  if(variable==='Sidewalk restrictions(BIKE)'){
    const c={'cannot ride on the sidewalks':'#d73027',
             'can ride on the sidewalks':'#1a9641',
             'can ride on the sidewalks with exceptions':'#fdae61',
             'cannot ride on sidewalk, unless local law permits':'#377eb8'};
    return c[canon(value)]||'#ccc';
  }
  if(variable==='Helmet_Law(BIKE)'){
    const v=canon(value);
    if(v.startsWith('not required')) return '#1a9641';
    if(v.includes('under 12'))       return '#d4eea2';
    if(v.includes('under 14'))       return '#ffffb2';
    if(v.includes('under 15'))       return '#fed976';
    if(v.includes('under 16'))       return '#feb24c';
    if(v.includes('under 17'))       return '#fd8d3c';
    if(v.includes('under 18'))       return '#e31a1c';
    return '#ccc';
  }
  if(variable==='specific_equipment_requirements(BIKE)'){
    const v=canon(value);
    if(v.includes('serial number'))  return '#ff7f00';
    if(v.includes('reflector')||v.includes('seat')||v.includes('bell')||v.includes('wheel')) return '#fdae61';
    if(v.includes('front')&&v.includes('rear')&&v.includes('lights')&&v.includes('brake')) return '#1a9641';
    if(v.includes('front')&&v.includes('rear')&&v.includes('lights')) return '#a6d96a';
    return '#ccc';
  }
  if(variable==='Access(BIKE)'){
    const v=canon(value);
    if(v==='fully allowed') return '#1a9641';
    if(v==='allowed unless signage prohibits') return '#fdae61';
    if(v==='prohibited unless signage allows') return '#d73027';
    if(v.startsWith('conditional')) return '#8c8c8c';
    return '#ccc';
  }
  if(variable==='Motor_Vehicle_passing_distance(BIKE)'){
    const v=canon(value);
    if(v==='2 ft'||v==='2ft')                          return '#d9f0a3';
    if(v==='3 ft'||v==='3ft')                          return '#a6d96a';
    if(v==='4 ft'||v==='4ft')                          return '#66bd63';
    if(v==='6 ft'||v==='6ft')                          return '#1a9641';
    if(v==='3 ft for under 35mph, 6ft for over')       return '#fdae61'; // speed-based
    if(v.startsWith('adjacent lane'))                  return '#fc8d59';
    if(v.startsWith('safe'))                           return '#8c6bb1';
    return '#ccc';
  }
  return '#ccc';
}

/* ===== REST OF SCRIPT IDENTICAL (updateLegend, popups, etc.) ===== */
</script>
</body>
</html>
