<!DOCTYPE html>
<html>
<head>
  <title>US State Map – Micromobility Policy</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;font-family:Arial,sans-serif;color:#142b59}
    #map-wrapper{display:flex;flex-direction:column;height:100vh;width:95%;margin:0 auto;padding:10px;border:5px solid #ccc;box-shadow:0 4px 10px rgba(0,0,0,.3);background:#fff}
    .info.legend{background:#142b59;color:#fff;padding:12px 16px;font:16px/20px Arial,sans-serif;box-shadow:0 2px 10px rgba(0,0,0,.2);border-radius:8px;max-width:90vw}
    .info.legend i{width:20px;height:20px;display:inline-block;margin-right:10px;margin-bottom:5px;vertical-align:middle;border-radius:3px}
    @media(max-width:600px){.info.legend{font:14px/18px Arial,sans-serif;padding:8px 12px;max-width:85vw}}
    .leaflet-popup-content a{color:#00539b;font-weight:bold;text-decoration:underline}.leaflet-popup-content a:hover{color:#ec1f2f}
    .leaflet-tooltip.state-label{font-size:7px;font-weight:bold;color:#333;background:transparent;border:none;box-shadow:none;text-shadow:1px 1px 2px #fff;pointer-events:none}
  </style>
</head>

<body>
<div id="map-wrapper">
  <div style="text-align:center;font-size:35px;font-weight:bold;margin-bottom:10px;">Micromobility Regulations in United States</div>

  <!----- top controls --->
  <div id="logos" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;padding:10px 20px;">
    <img src="logo-funder.jpg" alt="Funder Logo" style="height:80px;width:200px;object-fit:contain;padding:5px">
    <div style="display:flex;flex-wrap:wrap;gap:20px;">
      <div style="border:2px solid #ccc;border-radius:10px;padding:12px 16px;background:#fafafa;width:250px">
        <label for="mode-select" style="font-size:16px;font-weight:bold;margin-bottom:6px;display:block">Mode</label>
        <select id="mode-select" style="padding:12px 16px;font-size:16px;border-radius:8px;border:1px solid #ccc;background:#f9f9f9;width:100%">
          <option value="E-bike">E-bike</option>
          <option value="E-scooter">E-scooter</option>
          <option value="Conventional bicycle">Conventional bicycle</option>
          <option value="Moped">Moped</option>
          <option value="Other wheeled modes">Other wheeled modes</option>
        </select>
      </div>
      <div style="border:2px solid #ccc;border-radius:10px;padding:12px 16px;background:#fafafa;width:250px">
        <label for="variable-select" style="font-size:16px;font-weight:bold;margin-bottom:6px;display:block">Variable</label>
        <select id="variable-select" style="padding:12px 16px;font-size:16px;border-radius:8px;border:1px solid #ccc;background:#f9f9f9;width:100%"></select>
      </div>
    </div>
    <img src="logo-UTK.png" alt="University Logo" style="height:95px;width:200px;object-fit:contain;padding:5px">
  </div>

  <div style="text-align:center;margin-bottom:10px;">
    <button id="toggle-city-list" style="background:#142b59;color:#fff;padding:8px 16px;border:none;border-radius:5px;font-size:16px;cursor:pointer">Show/Hide City List</button>
  </div>

  <div id="city-list" style="display:none;text-align:center;margin-bottom:10px;font-size:16px;color:#142b59"></div>
  <div id="map" style="flex-grow:1;min-height:60vh"></div>

  <div id="footer" style="text-align:center;padding:10px;font-size:14px;color:#555">
    <div style="font-weight:bold">Created by the Team at the University of Tennessee, Knoxville</div>
    <div style="font-size:13px;color:#777;margin-top:4px">for Safety of Micromobility: Regulations, Data, and Stakeholders</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="us-states.js"></script>

<script>
/* ========== VARIABLE CONFIG ========== */
const modeVariables = {
  'E-bike': [
    { value:'Age_Class3_(E-Bike)', label:'Age Requirement for Class 3 E-bikes' },
    { value:'Helmet_Grouped_(E-Bike)', label:'Helmet Requirement' },
    { value:'Sidewalk_Riding_(E-Bike)', label:'Sidewalk Riding Restrictions' }
  ],
  'E-scooter': [
    { value:'License_Req_Grouped', label:'License Requirement for Riding' },
    { value:'Age_limit', label:'Minimum Riding Age' },
    { value:'Helmet_Requirement', label:'Helmet Requirement for Riding' }
  ],
  'Conventional bicycle': [
    { value:'Sidewalk restrictions(BIKE)',          label:'Sidewalk Riding Restrictions' },
    { value:'Helmet_Law(BIKE)',                     label:'Helmet Requirement' },
    { value:'specific_equipment_requirements(BIKE)',label:'Equipment Requirements' },
    { value:'Access(BIKE)',                         label:'Roadway Access' },
    { value:'Motor_Vehicle_passing_distance(BIKE)', label:'Passing-Distance Rule' }
  ],
  'Moped': [],
  'Other wheeled modes': []
};

/* ----- legend orders ----- */
const sidewalkOrder = [
  'Can ride','Partial allowed','Cannot ride but can stand and park',
  'Cannot ride certain classes','Cannot ride'
];
const bikeSidewalkOrder = [
  'Can ride on the sidewalks',
  'Can ride on the sidewalks with exceptions',
  'Cannot ride on sidewalk, unless local law permits',
  'Cannot ride on the sidewalks'
];
const ageLimitOrder = ['8','12','14','15','16','Regulated at local level','Prohibited'];

const helmetBikeOrder = [
  'Not required',
  'Required for users under 12',
  'Required for users under 14',
  'Required for users under 15',
  'Required for users under 16',
  'Required for users under 17',
  'Required for users under 18'
];
const equipmentOrder = [
  'Front and rear lights, brakes',
  'Front and rear lights',
  'Lights + reflectors / seat / other',
  'Includes serial number',
  'Unspecified / Other'
];
const accessBikeOrder = [
  'Fully allowed',
  'Allowed unless signage prohibits',
  'Prohibited unless signage allows',
  'Conditional or discretionary'
];
const passingDistanceOrder = [
  '2 ft',
  '3 ft or adjacent lane',
  '4 ft',
  '6 ft',
  'Speed-based (3 or 6 ft)',
  'Safe distance'
];

/* ========== MAP ========== */
const map=L.map('map').setView([37.8,-96],4);
map.zoomControl.setPosition('bottomleft');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
 {attribution:'Map data © OpenStreetMap contributors'}).addTo(map);

/* ========== DATA ========== */
const sheetURL='https://docs.google.com/spreadsheets/d/e/2PACX-1vQrQxPEts8ty9L0LPKEw7kD80wc0ZygZrSM57kYHTkgAcvHR6-1qQ2Y3OV70-bcYv4ZuXVsdsWx88GB/pub?output=csv';
let dataLookup={},geojsonLayer,currentLegend;
let currentMode='E-bike',currentVariable='Age_Class3_(E-Bike)';

fetch(sheetURL).then(r=>r.text()).then(txt=>{
  Papa.parse(txt,{header:true}).data.forEach(row=>{
    const s=row.State?.trim();if(s)dataLookup[s]=row;
  });

  geojsonLayer=L.geoJson(statesData,{
    style:f=>styleState(f,currentVariable),
    onEachFeature:(_,layer)=>bindPopup(layer)
  }).addTo(map);

  geojsonLayer.eachLayer(l=>l.bindTooltip(
    l.feature.properties.name,{permanent:true,direction:'center',className:'state-label'}).openTooltip());

  fillVariableDropdown(currentMode);
  updateLegend(currentVariable);
});

/* ========== UI HANDLERS ========== */
document.getElementById('mode-select').addEventListener('change',e=>{
  currentMode=e.target.value;fillVariableDropdown(currentMode);
});
document.getElementById('variable-select').addEventListener('change',e=>{
  currentVariable=e.target.value;
  geojsonLayer.setStyle(f=>styleState(f,currentVariable));
  updateLegend(currentVariable);updatePopups();
});

/* ========== DROPDOWN FILL ========== */
function fillVariableDropdown(mode){
  const sel=document.getElementById('variable-select');sel.innerHTML='';
  const vars=modeVariables[mode];
  if(!vars.length){sel.innerHTML='<option>No variables</option>';sel.disabled=true;return;}
  vars.forEach(v=>{const o=document.createElement('option');o.value=v.value;o.textContent=v.label;sel.appendChild(o);});
  sel.disabled=false;currentVariable=vars[0].value;
  geojsonLayer.setStyle(f=>styleState(f,currentVariable));
  updateLegend(currentVariable);updatePopups();
}

/* ========== STYLING ========== */
function styleState(feature,variable){
  const v=dataLookup[feature.properties.name]?.[variable];
  return {fillColor:getColor(v,variable)||'#ccc',weight:1,color:'white',fillOpacity:getColor(v,variable)?0.7:0};
}

/* --- canonical helper --- */
const canon=v=>(v??'').trim().replace(/\s+/g,' ').toLowerCase();

/* --- colour lookup --- */
function getColor(value,variable){
  if(!value||value==='NA'||value==='Mode not defined'){
    if(variable==='Age_limit') value='Regulated at local level';else return '#cccccc';
  }

  /* ---- E-bike & E-scooter (unchanged) ---- */
  if(variable==='Age_Class3_(E-Bike)'){
    if(value==='None') return '#ffffb2';
    const n=parseInt(value);return !isNaN(n)&&n>=16?'#1a9641':'#fdae61';
  }
  if(variable==='Helmet_Grouped_(E-Bike)'){
    const h={
      '12 or below':'#a6cee3','14 or below':'#1f78b4','15 or below':'#b2df8a','16 or below':'#33a02c',
      '17 or below':'#fb9a99','18 or below':'#e31a1c','21 or below':'#fdbf6f','not required':'#cab2d6',
      'required for all users':'#6a3d9a'
    };
    const k=Object.keys(h).find(k=>k.toLowerCase()===canon(value));return h[k]||'#ccc';
  }
  if(variable==='Sidewalk_Riding_(E-Bike)'){
    const c={'can ride':'#1a9641','partial allowed':'#fdae61','cannot ride certain classes':'#984ea3','cannot ride':'#d73027','cannot ride but can stand and park':'#377eb8'};
    return c[canon(value)]||'#ccc';
  }
  if(variable==='License_Req_Grouped'){
    const c={'DL not required':'#1a9641','DL or permit required':'#fdae61','DL required':'#d73027','prohibited':'#7570b3'};
    return c[value]||'#ccc';
  }
  if(variable==='Age_limit'){
    let v=canon(value);if(v==='mode not defined') v='regulated at local level';
    const c={'8':'#1a9641','12':'#a6d96a','14':'#fdae61','15':'#f46d43','16':'#d73027','regulated at local level':'#ffffbf','prohibited':'#7570b3'};
    return c[v]||'#ccc';
  }
  if(variable==='Helmet_Requirement'){
    const c={'not required':'#1a9641','under 16':'#a6d96a','under 17':'#fdae61','under 18':'#f46d43','under 19':'#d73027','riders all age':'#66c2a5','mode prohibited':'#7570b3'};
    return c[canon(value)]||'#ccc';
  }

  /* ---- Conventional-bike variables ---- */

  /* 1. Sidewalk riding */
  if(variable==='Sidewalk restrictions(BIKE)'){
    const c={'cannot ride on the sidewalks':'#d73027','can ride on the sidewalks':'#1a9641','can ride on the sidewalks with exceptions':'#fdae61','cannot ride on sidewalk, unless local law permits':'#377eb8'};
    return c[canon(value)]||'#ccc';
  }

  /* 2. Helmet law */
  if(variable==='Helmet_Law(BIKE)'){
    const v=canon(value);
    if(v.startsWith('not required'))                       return '#1a9641';
    if(v.includes('under 12'))                             return '#d4eea2';
    if(v.includes('under 14'))                             return '#ffffb2';
    if(v.includes('under 15'))                             return '#fed976';
    if(v.includes('under 16'))                             return '#feb24c';
    if(v.includes('under 17'))                             return '#fd8d3c';
    if(v.includes('under 18'))                             return '#e31a1c';
    return '#cccccc';
  }

  /* 3. Equipment requirements */
  if(variable==='specific_equipment_requirements(BIKE)'){
    const v=canon(value);
    if(v.includes('serial number'))                        return '#ff7f00';   // Includes serial number
    if(v.includes('reflector')||v.includes('seat')||v.includes('bell')||v.includes('wheel')) return '#fdae61'; // lights + extras
    if(v.includes('front')&&v.includes('rear')&&v.includes('lights')&&v.includes('brake')) return '#1a9641';   // lights+brakes
    if(v.includes('front')&&v.includes('rear')&&v.includes('lights')&&!v.includes('brake')) return '#a6d96a';    // lights only
    return '#cccccc';                                      // unspecified/other
  }

  /* 4. Access */
  if(variable==='Access(BIKE)'){
    const v=canon(value);
    if(v==='fully allowed')                                return '#1a9641';
    if(v==='allowed unless signage prohibits')             return '#fdae61';
    if(v==='prohibited unless signage allows')             return '#d73027';
    if(v.startsWith('conditional'))                        return '#8c8c8c';
    return '#cccccc';
  }

  /* 5. Passing distance */
  if(variable==='Motor_Vehicle_passing_distance(BIKE)'){
    const v=canon(value);
    if(v==='2 ft'||v==='2ft')                              return '#d9f0a3';
    if(v.startsWith('3')||v.includes('adjacent lane'))     return '#a6d96a';   // 3 ft OR adjacent lane
    if(v==='4 ft'||v==='4ft')                              return '#66bd63';
    if(v==='6 ft'||v==='6ft')                              return '#1a9641';
    if(v.startsWith('speed'))                              return '#fdae61';   // speed-based
    if(v.startsWith('safe'))                               return '#8c6bb1';   // safe distance
    return '#cccccc';
  }

  return '#ccc';
}

/* ========== LEGEND ========== */
function updateLegend(variable){
  if(currentLegend) map.removeControl(currentLegend);
  currentLegend=L.control({position:'bottomright'});
  currentLegend.onAdd=()=>{
    const div=L.DomUtil.create('div','info legend'),mapVals=new Map();
    Object.values(dataLookup).forEach(row=>{
      let v=row?.[variable];if(!v||v==='NA') return;
      if(variable==='Age_limit'&&canon(v)==='mode not defined') v='Regulated at local level';
      mapVals.set(canon(v),v.trim());
    });

    const ordered =
      variable==='Sidewalk_Riding_(E-Bike)'               ? sidewalkOrder.filter(l=>mapVals.has(canon(l))) :
      variable==='Sidewalk restrictions(BIKE)'            ? bikeSidewalkOrder.filter(l=>mapVals.has(canon(l))) :
      variable==='Age_limit'                              ? ageLimitOrder.filter(l=>mapVals.has(canon(l))) :
      variable==='Helmet_Law(BIKE)'                       ? helmetBikeOrder.filter(l=>mapVals.has(canon(l))) :
      variable==='specific_equipment_requirements(BIKE)'  ? equipmentOrder.filter(l=>mapVals.has(canon(l))) :
      variable==='Access(BIKE)'                           ? accessBikeOrder.filter(l=>mapVals.has(canon(l))) :
      variable==='Motor_Vehicle_passing_distance(BIKE)'   ? passingDistanceOrder.filter(l=>mapVals.has(canon(l))) :
      Array.from(mapVals.values()).sort();

    div.innerHTML=ordered.map(cat=>`<i style="background:${getColor(cat,variable)}"></i> ${cat}`).join('<br>');
    return div;
  };
  currentLegend.addTo(map);
}

/* ========== POPUPS ========== */
function bindPopup(layer){
  const state=layer.feature.properties.name;
  let val=dataLookup[state]?.[currentVariable]||'N/A';
  if(currentVariable==='Age_limit'&&canon(val)==='mode not defined') val='Regulated at local level';
  const label=modeVariables[currentMode].find(v=>v.value===currentVariable)?.label||currentVariable;
  const pdf=dataLookup[state]?.PDF_URL||'';
  layer.bindPopup(`<b>${state}</b><br><strong>Mode:</strong> ${currentMode}<br><strong>Variable:</strong> ${label}<br><strong>Category:</strong> ${val}<br>${pdf?`<a href="${pdf}" target="_blank">View State Regulation PDF</a>`:''}`);
}
function updatePopups(){geojsonLayer.eachLayer(bindPopup);}

/* ========== CITY MARKERS (unchanged) ========== */
const cities=[
  {name:'Atlanta, GA',coords:[33.749,-84.388],pdf_url:'#'},
  {name:'Austin, TX',coords:[30.2672,-97.7431],pdf_url:'#'},
  {name:'Boston, MA',coords:[42.3601,-71.0589],pdf_url:'#'},
  {name:'Denver, CO',coords:[39.7392,-104.9903],pdf_url:'#'},
  {name:'Madison, WI',coords:[43.0731,-89.4012],pdf_url:'#'},
  {name:'Minneapolis, MN',coords:[44.9778,-93.265],pdf_url:'#'},
  {name:'Portland, OR',coords:[45.5051,-122.675],pdf_url:'#'},
  {name:'Richmond, VA',coords:[37.5407,-77.436],pdf_url:'#'},
  {name:'St. Louis, MO',coords:[38.627,-90.1994],pdf_url:'#'},
  {name:'Washington, D.C.',coords:[38.9072,-77.0369],pdf_url:'#'},
  {name:'New York, NY',coords:[40.7128,-74.006],pdf_url:'#'},
  {name:'Philadelphia, PA',coords:[39.9526,-75.1652],pdf_url:'#'},
  {name:'Tampa, FL',coords:[27.9506,-82.4572],pdf_url:'#'},
  {name:'Los Angeles, CA',coords:[34.0522,-118.2437],pdf_url:'#'},
  {name:'Seattle, WA',coords:[47.6062,-122.3321],pdf_url:'#'},
  {name:'Phoenix, AZ',coords:[33.4484,-112.074],pdf_url:'#'}
];
const cityMarkers={},btn=document.getElementById('toggle-city-list');let visible=true;
cities.forEach(c=>cityMarkers[c.name]=L.marker(c.coords).addTo(map).bindPopup(`<strong>${c.name}</strong><br><a href="${c.pdf_url}" target="_blank">View City Regulation PDF</a>`));
btn.addEventListener('click',()=>{
  document.getElementById('city-list').style.display=document.getElementById('city-list').style.display==='none'?'block':'none';
  visible=!visible;Object.values(cityMarkers).forEach(m=>visible?m.addTo(map):map.removeLayer(m));
});
</script>
</body>
</html>
