<!DOCTYPE html>
<html>
<head>
  <title>US State Map - E-Bike Policy</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      color: #142b59;
    }
    #map-wrapper {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 95%;
      margin: 0 auto;
      padding: 10px;
      border: 5px solid #ccc;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      background-color: white;
    }
    .info.legend {
      background: #142b59;
      color: #ffffff;
      padding: 12px 16px;
      font: 16px/20px Arial, sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      border-radius: 8px;
      width: auto;
      max-width: 90vw;
    }
    .info.legend i {
      width: 20px;
      height: 20px;
      display: inline-block;
      margin-right: 10px;
      margin-bottom: 5px;
      vertical-align: middle;
      border-radius: 3px;
    }
    @media (max-width: 600px) {
      .info.legend {
        font: 14px/18px Arial, sans-serif;
        padding: 8px 12px;
        max-width: 85vw;
      }
    }
    .leaflet-popup-content a {
      color: #00539b;
      font-weight: bold;
      text-decoration: underline;
    }
    .leaflet-popup-content a:hover {
      color: #ec1f2f;
    }
  </style>
</head>

<body>
<div id="map-wrapper">
  <div style="text-align: center; font-size: 35px; font-weight: bold; margin-bottom: 10px;">
    Micromobility Regulations in United States
  </div>

  <div id="logos" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding: 10px 20px;">
    <img src="logo-funder.jpg" alt="Funder Logo" style="height: 80px; width: 200px;">
    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;">
      <div style="border: 2px solid #ccc; border-radius: 10px; padding: 12px; background-color: #fafafa; width: 250px;">
        <label for="mode-select" style="font-weight: bold;">Mode</label>
        <select id="mode-select" style="width: 100%; padding: 12px;">
          <option value="E-bike">E-bike</option>
          <option value="E-scooter">E-scooter</option>
          <option value="Conventional bicycle">Conventional bicycle</option>
          <option value="Moped">Moped</option>
          <option value="Other wheeled modes">Other wheeled modes</option>
        </select>
      </div>
      <div style="border: 2px solid #ccc; border-radius: 10px; padding: 12px; background-color: #fafafa; width: 250px;">
        <label for="variable-select" style="font-weight: bold;">Variable</label>
        <select id="variable-select" style="width: 100%; padding: 12px;"></select>
      </div>
    </div>
    <img src="logo-UTK.png" alt="University Logo" style="height: 95px; width: 200px;">
  </div>

  <div style="text-align: center; margin-bottom: 10px;">
    <button id="toggle-city-list" style="background-color: #142b59; color: white; padding: 8px 16px;">Show/Hide City List</button>
  </div>

  <div id="city-list" style="display: none; text-align: center; font-size: 16px;"></div>
  <div id="map" style="flex-grow: 1; min-height: 60vh;"></div>
  <div id="footer" style="text-align: center; padding: 10px; font-size: 14px; color: #555;">
    <div style="font-weight: bold;">Created by the Team at the University of Tennessee, Knoxville</div>
    <div style="font-size: 13px; color: #777;">for Safety of Micromobility: Regulations, Data, and Stakeholders</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="us-states.js"></script>

<script>
const modeVariables = {
  'E-bike': [
    { value: 'Age_Class3_(E-Bike)', label: 'Age Requirement for Class 3 E-bikes' },
    { value: 'Helmet_Grouped_(E-Bike)', label: 'Helmet Requirement' },
    { value: 'Sidewalk_Riding_(E-Bike)', label: 'Sidewalk Riding Restrictions' }
  ],
  'E-scooter': [
    { value: 'License_Req_Grouped', label: 'Driver’s License Requirement' }
  ],
  'Conventional bicycle': [],
  'Moped': [],
  'Other wheeled modes': []
};

const map = L.map('map').setView([37.8, -96], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Map data © OpenStreetMap contributors'
}).addTo(map);

const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQrQxPEts8ty9L0LPKEw7kD80wc0ZygZrSM57kYHTkgAcvHR6-1qQ2Y3OV70-bcYv4ZuXVsdsWx88GB/pub?output=csv';
let dataLookup = {};
let geojsonLayer, currentLegend;

fetch(sheetURL)
  .then(response => response.text())
  .then(csvText => {
    const data = Papa.parse(csvText, { header: true }).data;
    data.forEach(row => dataLookup[row.State] = row);
    geojsonLayer = L.geoJson(statesData, {
      style: f => getStyle(f, 'Age_Class3_(E-Bike)'),
      onEachFeature: (feature, layer) => {
        const state = feature.properties.name;
        const row = dataLookup[state];
        if (row) {
          const popup = `
            <b>${state}</b><br>
            <div style="margin-top: 6px;">
              <strong>Age Requirement (Class 3):</strong> ${row["Age_requirement_(E-Bike)"] || 'N/A'}<br>
              <strong>Helmet Law:</strong> ${row["Helmet_requirement_(Text)_(E-Bike)"] || 'N/A'}<br>
              <strong>Sidewalk Restrictions:</strong> ${row["Sidewalk_restrictions_(E-Bike)"] || 'N/A'}
            </div>
            <div style="margin-top: 12px;">
              <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" width="40">
              <a href="${row.PDF_URL}" target="_blank">View Full Regulation PDF</a>
            </div>`;
          layer.bindPopup(popup);
        }
      }
    }).addTo(map);
    updateVariableDropdown('E-bike');
    updateLegend('Age_Class3_(E-Bike)');
  });

document.getElementById('mode-select').addEventListener('change', function () {
  updateVariableDropdown(this.value);
});
document.getElementById('variable-select').addEventListener('change', function () {
  const variable = this.value;
  geojsonLayer.setStyle(f => getStyle(f, variable));
  updateLegend(variable);
});

function updateVariableDropdown(mode) {
  const select = document.getElementById('variable-select');
  select.innerHTML = '';
  if (modeVariables[mode].length === 0) {
    select.innerHTML = '<option>No variables yet</option>';
    select.disabled = true;
  } else {
    select.disabled = false;
    modeVariables[mode].forEach(item => {
      const option = document.createElement('option');
      option.value = item.value;
      option.textContent = item.label;
      select.appendChild(option);
    });
    geojsonLayer.setStyle(f => getStyle(f, modeVariables[mode][0].value));
    updateLegend(modeVariables[mode][0].value);
  }
}

function getStyle(f, variable) {
  const val = dataLookup[f.properties.name]?.[variable];
  return {
    fillColor: getColor(val, variable),
    weight: 1,
    color: 'white',
    fillOpacity: 0.7
  };
}

function getColor(val, variable) {
  if (!val || val === 'NA') return '#d3d3d3';
  if (variable === 'Age_Class3_(E-Bike)') {
    if (val === 'None') return '#ffffb2';
    const n = parseInt(val);
    return !isNaN(n) ? (n >= 16 ? "#1a9641" : "#fdae61") : '#ccc';
  }
  if (variable === 'Helmet_Grouped_(E-Bike)') {
    return { 'Under_18': '#3288bd', 'Under_16': '#66c2a5', 'No': '#fdae61' }[val] || '#ccc';
  }
  if (variable === 'Sidewalk_Riding_(E-Bike)') {
    const map = {
      'Can ride': '#1a9641',
      'Cannot ride': '#d7191c',
      'Partial allowed': '#fdae61',
      'Cannot ride certain classes': '#984ea3',
      'Cannot ride but can stand and park': '#377eb8'
    };
    return map[val] || '#ccc';
  }
  if (variable === 'License_Req_Grouped') {
    return {
      'DL not required': '#1a9641',
      'DL or permit required': '#fdae61',
      'Check this one': '#d7191c',
      'Mode not defined': '#d3d3d3'
    }[val] || '#ccc';
  }
  return '#ccc';
}

function updateLegend(variable) {
  if (currentLegend) map.removeControl(currentLegend);
  currentLegend = L.control({ position: 'bottomright' });
  currentLegend.onAdd = function () {
    const div = L.DomUtil.create('div', 'info legend');
    let labels = [];
    if (variable === 'License_Req_Grouped') {
      const cats = ['DL not required', 'DL or permit required', 'Check this one', 'Mode not defined'];
      const labelsMap = {
        'DL not required': 'No driver’s license required',
        'DL or permit required': 'License or permit required',
        'Check this one': 'Unclear or conflicting info',
        'Mode not defined': 'No data / mode not defined'
      };
      labels = cats.map(cat => `<i style="background:${getColor(cat, variable)}"></i> ${labelsMap[cat]}`);
    }
    div.innerHTML = labels.join('<br>');
    return div;
  };
  currentLegend.addTo(map);
}
</script>
</body>
</html>
