<!DOCTYPE html>
<html>
<head>
  <title>US State Map - E-Bike Policy</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map-wrapper {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 95%; /* small side margin */
      max-width: none;
      margin: 0 auto;
      padding: 10px;
      border: 5px solid #ccc;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      background-color: white;
    }

    .info.legend {
      background: white;
      padding: 12px 16px;
      font: 16px/20px Arial, sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      border-radius: 8px;
      line-height: 1.2;
      max-width: 250px;
    }

    .info.legend i {
      width: 20px;
      height: 20px;
      display: inline-block;
      margin-right: 10px;
      margin-bottom: 5px;
      vertical-align: middle;
      border-radius: 3px;
    }

    @media (max-width: 600px) {
      .info.legend {
        font: 14px/18px Arial, sans-serif;
        padding: 8px 12px;
        max-width: 85vw;
      }
    }
  </style>
</head>

<body>

  <!-- Wrapper -->
  <div id="map-wrapper">

    <!-- Heading -->
    <div style="
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    ">
      Micromobility Regulations in the United States
    </div>

    <!-- Logos and dropdown -->
    <div id="logos" style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      padding: 10px 20px;
    ">
      <!-- Left logo -->
      <img src="logo-funder.jpg" alt="Funder Logo" style="
        height: 80px;
        width: 200px;
        object-fit: contain;
        padding: 5px;
        box-sizing: border-box;
      ">

      <!-- Dropdown in middle -->
      <select id="variable-select" style="
        padding: 10px 15px;
        font-size: 18px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin: 10px;
      ">
        <option value="Age_Class3">Age Requirement (Class 3 E-bikes)</option>
        <option value="Helmet_Grouped">Helmet Requirement</option>
      </select>

      <!-- Right logo -->
      <img src="logo-UTK.png" alt="University Logo" style="
        height: 90px;
        width: 200px;
        object-fit: contain;
        padding: 5px;
        box-sizing: border-box;
      ">
    </div>

    <!-- Map -->
    <div id="map" style="flex-grow: 1; min-height: 60vh;"></div>

    <!-- Footer -->
    <div id="footer" style="
      text-align: center;
      padding: 10px;
      font-size: 14px;
      color: #555;
    ">
      Created by Sameer Aryal at University of Tennessee, Knoxville
    </div>

  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="us-states.js"></script>

  <script>
    const map = L.map('map').setView([37.8, -96], 4);
    map.zoomControl.setPosition('bottomleft');

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© OpenStreetMap contributors'
    }).addTo(map);

    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQrQxPEts8ty9L0LPKEw7kD80wc0ZygZrSM57kYHTkgAcvHR6-1qQ2Y3OV70-bcYv4ZuXVsdsWx88GB/pub?output=csv';
    let dataLookup = {};
    let geojsonLayer;
    let currentLegend;

    fetch(sheetURL)
      .then(response => response.text())
      .then(csvText => {
        const data = Papa.parse(csvText, { header: true }).data;
        data.forEach(row => {
          dataLookup[row.State] = row;
        });

        geojsonLayer = L.geoJson(statesData, {
          style: feature => getStyle(feature, 'Age_Class3'),
          onEachFeature: (feature, layer) => {
            const state = feature.properties.name;
            const row = dataLookup[state];
            if (row) {
              const popup = `
                <b>${state}</b><br>
                Age Requirement (Class 3): ${row.Age_Class3 || 'N/A'}<br>
                Helmet Law: ${row["Helmet_requirement_(Text)"] || 'N/A'}<br>
                <iframe src="${row.PDF_URL}" width="250" height="300" style="border:none;"></iframe><br>
                <a href="${row.PDF_URL}" target="_blank">Open full PDF</a>`;
              layer.bindPopup(popup);
            }
          }
        }).addTo(map);

        // Initial legend
        updateLegend('Age_Class3');
      });

    document.getElementById('variable-select').addEventListener('change', function () {
      const variable = this.value;
      geojsonLayer.setStyle(feature => getStyle(feature, variable));
      updateLegend(variable);
    });

    function getStyle(feature, variable) {
      const state = feature.properties.name;
      const value = dataLookup[state]?.[variable];
      return {
        fillColor: getColor(value, variable),
        weight: 1,
        color: 'white',
        fillOpacity: 0.7
      };
    }

    function getColor(value, variable) {
      if (!value || value === 'NA') return '#d3d3d3';

      if (variable === 'Age_Class3') {
        if (value === "None") return "#ffffb2";
        const num = parseInt(value);
        if (!isNaN(num)) return num >= 16 ? "#1a9641" : "#fdae61";
      }

      if (variable === 'Helmet_Grouped') {
        if (value === 'Under_18') return '#3288bd';
        if (value === 'Under_16') return '#66c2a5';
        if (value === 'No') return '#fdae61';
        if (value === 'NA') return '#d3d3d3';
      }

      return '#ccc';
    }

    function updateLegend(variable) {
      if (currentLegend) map.removeControl(currentLegend);

      currentLegend = L.control({ position: 'bottomright' });

      currentLegend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend');
        let labels = [];

        if (variable === 'Age_Class3') {
          const values = ['None', 14, 15, 16, 'NA'];
          labels = values.map(v => {
            const label = v === 'None' ? 'No Restriction'
                        : v === 'NA' ? 'Not Available'
                        : `${v}+`;
            return `<i style="background:${getColor(v, variable)}"></i> ${label}`;
          });
        }

        if (variable === 'Helmet_Grouped') {
          const categories = ['Under_18', 'Under_16', 'No', 'NA'];
          const labelsMap = {
            'Under_18': 'Under 18 only',
            'Under_16': 'Under 16 only',
            'No': 'No requirement',
            'NA': 'Not available'
          };
          labels = categories.map(cat =>
            `<i style="background:${getColor(cat, variable)}"></i> ${labelsMap[cat]}`
          );
        }

        div.innerHTML = labels.join('<br>');
        return div;
      };

      currentLegend.addTo(map);
    }
  </script>

</body>
</html>
