<!DOCTYPE html>
<html>
<head>
  <title>US State Map – Micromobility Policy</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;font-family:Arial,sans-serif;color:#142b59}
    #map-wrapper{display:flex;flex-direction:column;height:100vh;width:95%;margin:0 auto;padding:10px;border:5px solid #ccc;box-shadow:0 4px 10px rgba(0,0,0,.3);background:#fff}
    .info.legend{background:#142b59;color:#fff;padding:12px 16px;font:16px/20px Arial,sans-serif;box-shadow:0 2px 10px rgba(0,0,0,.2);border-radius:8px;max-width:90vw}
    .info.legend i{width:20px;height:20px;display:inline-block;margin-right:10px;margin-bottom:5px;vertical-align:middle;border-radius:3px}
    @media(max-width:600px){.info.legend{font:14px/18px Arial,sans-serif;padding:8px 12px;max-width:85vw}}
    .leaflet-popup-content a{color:#00539b;font-weight:bold;text-decoration:underline}
    .leaflet-popup-content a:hover{color:#ec1f2f}
    .leaflet-tooltip.state-label{font-size:7px;font-weight:bold;color:#333;background:transparent;border:none;box-shadow:none;text-shadow:1px 1px 2px #fff;pointer-events:none}
  </style>
</head>

<body>
<div id="map-wrapper">
  <div style="text-align:center;font-size:35px;font-weight:bold;margin-bottom:10px;">Micromobility Regulations in United States</div>

  <!-- top controls -->
  <div id="logos" style="display:flex;justify-content:space-between;flex-wrap:wrap;align-items:center;padding:10px 20px;">
    <img src="logo-funder.jpg" alt="Funder Logo" style="height:80px;width:200px;object-fit:contain;padding:5px">
    <div style="display:flex;gap:20px;flex-wrap:wrap;">
      <div style="border:2px solid #ccc;border-radius:10px;padding:12px 16px;background:#fafafa;width:250px">
        <label for="mode-select" style="font:16px Arial;font-weight:bold;margin-bottom:6px;display:block">Mode</label>
        <select id="mode-select" style="padding:12px 16px;font-size:16px;border-radius:8px;border:1px solid #ccc;background:#f9f9f9;width:100%">
          <option value="E-bike">E-bike</option>
          <option value="E-scooter">E-scooter</option>
          <option value="Conventional bicycle">Conventional bicycle</option>
          <option value="Moped">Moped</option>
          <option value="Other wheeled modes">Other wheeled modes</option>
        </select>
      </div>
      <div style="border:2px solid #ccc;border-radius:10px;padding:12px 16px;background:#fafafa;width:250px">
        <label for="variable-select" style="font:16px Arial;font-weight:bold;margin-bottom:6px;display:block">Variable</label>
        <select id="variable-select" style="padding:12px 16px;font-size:16px;border-radius:8px;border:1px solid #ccc;background:#f9f9f9;width:100%"></select>
      </div>
    </div>
    <img src="logo-UTK.png" alt="University Logo" style="height:95px;width:200px;object-fit:contain;padding:5px">
  </div>

  <div style="text-align:center;margin-bottom:10px;">
    <button id="toggle-city-list" style="background:#142b59;color:#fff;padding:8px 16px;border:none;border-radius:5px;font-size:16px;cursor:pointer">Show/Hide City List</button>
  </div>

  <div id="city-list" style="display:none;text-align:center;margin-bottom:10px;font-size:16px;color:#142b59"></div>
  <div id="map" style="flex-grow:1;min-height:60vh"></div>

  <div id="footer" style="text-align:center;padding:10px;font-size:14px;color:#555">
    <div style="font-weight:bold">Created by the Team at the University of Tennessee, Knoxville</div>
    <div style="font-size:13px;color:#777;margin-top:4px">for Safety of Micromobility: Regulations, Data, and Stakeholders</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="us-states.js"></script>

<script>
/* ===== VARIABLE CONFIG ===== */
const modeVariables={
  'E-bike':[
    {value:'Age_Class3_(E-Bike)',label:'Age Requirement for Class 3 E-bikes'},
    {value:'Helmet_Grouped_(E-Bike)',label:'Helmet Requirement'},
    {value:'Sidewalk_Riding_(E-Bike)',label:'Sidewalk Riding Restrictions'}
  ],
  'E-scooter':[
    {value:'License_Req_Grouped',label:'License Requirement for Riding'},
    {value:'Age_limit',label:'Minimum Riding Age'},
    {value:'Helmet_Requirement',label:'Helmet Requirement for Riding'}
  ],
  'Conventional bicycle':[
    {value:'Sidewalk restrictions(BIKE)',label:'Sidewalk Riding Restrictions'},
    {value:'Helmet_Law(BIKE)',label:'Helmet Requirement'},
    {value:'specific_equipment_requirements(BIKE)',label:'Equipment Requirements'},
    {value:'Access(BIKE)',label:'Roadway Access'},
    {value:'Motor_Vehicle_passing_distance(BIKE)',label:'Passing-Distance Rule'}
  ],
  'Moped':[],
  'Other wheeled modes':[]
};

/* ----- Legend orders ----- */
const sidewalkOrder=['Can ride','Partial allowed','Cannot ride but can stand and park','Cannot ride certain classes','Cannot ride'];
const bikeSidewalkOrder=['Can ride on the sidewalks','Can ride on the sidewalks with exceptions','Cannot ride on sidewalk, unless local law permits','Cannot ride on the sidewalks'];
const ageLimitOrder=['8','12','14','15','16','Regulated at local level','Prohibited'];
const helmetBikeOrder=['Not required','Required for users under 12','Required for users under 14','Required for users under 15','Required for users under 16','Required for users under 17','Required for users under 18'];
const equipmentOrder=['Front and rear lights, brakes','Front and rear lights','Lights + reflectors / seat / other','Includes serial number','Unspecified / Other'];
const accessBikeOrder=['Fully allowed','Allowed unless signage prohibits','Prohibited unless signage allows','Conditional or discretionary'];
const passingDistanceOrder=['2 ft','3 ft','4 ft','6 ft','Speed-based (3 or 6 ft)','Adjacent lane','Safe distance'];

/* ===== MAP INIT ===== */
const map=L.map('map').setView([37.8,-96],4);map.zoomControl.setPosition('bottomleft');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Map data © OpenStreetMap contributors'}).addTo(map);

/* ===== DATA ===== */
const sheetURL='https://docs.google.com/spreadsheets/d/e/2PACX-1vQrQxPEts8ty9L0LPKEw7kD80wc0ZygZrSM57kYHTkgAcvHR6-1qQ2Y3OV70-bcYv4ZuXVsdsWx88GB/pub?output=csv';
let dataLookup={},geojsonLayer,currentLegend;
let currentMode='E-bike',currentVariable='Age_Class3_(E-Bike)';

/* --- CSV fetch --- */
fetch(sheetURL).then(r=>r.text()).then(txt=>{
  Papa.parse(txt,{header:true}).data.forEach(row=>{
    const s=row.State?.trim();if(s)dataLookup[s]=row;
  });
  geojsonLayer=L.geoJson(statesData,{style:f=>styleState(f,currentVariable),onEachFeature:(_,l)=>bindPopup(l)}).addTo(map);
  geojsonLayer.eachLayer(l=>l.bindTooltip(l.feature.properties.name,{permanent:true,direction:'center',className:'state-label'}).openTooltip());
  fillVariableDropdown(currentMode);updateLegend(currentVariable);
});

/* ===== UI HANDLERS ===== */
document.getElementById('mode-select').addEventListener('change',e=>{
  currentMode=e.target.value;fillVariableDropdown(currentMode);
});
document.getElementById('variable-select').addEventListener('change',e=>{
  currentVariable=e.target.value;
  geojsonLayer.setStyle(f=>styleState(f,currentVariable));
  updateLegend(currentVariable);updatePopups();
});

/* ===== DROPDOWN FILL ===== */
function fillVariableDropdown(mode){
  const sel=document.getElementById('variable-select');sel.innerHTML='';
  const vars=modeVariables[mode];
  if(!vars.length){sel.innerHTML='<option>No variables</option>';sel.disabled=true;return;}
  vars.forEach(v=>{const o=document.createElement('option');o.value=v.value;o.textContent=v.label;sel.appendChild(o);});
  sel.disabled=false;currentVariable=vars[0].value;
  geojsonLayer.setStyle(f=>styleState(f,currentVariable));
  updateLegend(currentVariable);updatePopups();
}

/* ===== STYLE / COLOR ===== */
const canon=v=>(v??'').trim().replace(/\s+/g,' ').toLowerCase();

function styleState(feature,variable){
  const raw=dataLookup[feature.properties.name]?.[variable];
  return {fillColor:getColor(raw,variable)||'#ccc',weight:1,color:'white',fillOpacity:getColor(raw,variable)?0.7:0};
}

function getColor(value,variable){
  if(!value||value==='NA'||value==='Mode not defined'){
    if(variable==='Age_limit') value='Regulated at local level';else return '#cccccc';
  }
  /* ---- existing branches omitted for brevity ---- */

  /* ----- 5. Passing distance (FIXED) ----- */
  if(variable==='Motor_Vehicle_passing_distance(BIKE)'){
    let v=canon(value);
    if(v==='2 ft'||v==='2ft')                                   return '#d9f0a3';
    if(v==='3 ft'||v==='3ft')                                   return '#a6d96a';
    if(v==='4 ft'||v==='4ft')                                   return '#66bd63';
    if(v==='6 ft'||v==='6ft')                                   return '#1a9641';
    if(v==='3 ft for under 35mph, 6ft for over'||
       v==='speed-based (3 or 6 ft)')                           return '#fdae61';
    if(v.startsWith('adjacent lane'))                           return '#fc8d59';
    if(v.startsWith('safe'))                                    return '#8c6bb1';
    return '#cccccc';
  }
  return '#ccc';
}

/* ===== LEGEND ===== */
function updateLegend(variable){
  if(currentLegend) map.removeControl(currentLegend);
  currentLegend=L.control({position:'bottomright'});
  currentLegend.onAdd=()=>{
    const div=L.DomUtil.create('div','info legend'),catMap=new Map();
    Object.values(dataLookup).forEach(r=>{
      let v=r?.[variable];if(!v||v==='NA') return;
      if(variable==='Age_limit'&&canon(v)=='mode not defined') v='Regulated at local level';

      /* unify passing-distance values */
      if(variable==='Motor_Vehicle_passing_distance(BIKE)'){
        const c=canon(v);
        if(c==='3 ft'||c==='3ft')                               v='3 ft';
        else if(c==='3 ft for under 35mph, 6ft for over')       v='Speed-based (3 or 6 ft)';
        else if(c.startsWith('adjacent lane'))                  v='Adjacent lane';
        else if(c.startsWith('safe'))                           v='Safe distance';
      }
      catMap.set(canon(v),v.trim());
    });

    const ordered =
      variable==='Motor_Vehicle_passing_distance(BIKE)'   ? passingDistanceOrder.filter(l=>catMap.has(canon(l))) :
      variable==='Sidewalk_Riding_(E-Bike)'               ? sidewalkOrder.filter(l=>catMap.has(canon(l))) :
      variable==='Sidewalk restrictions(BIKE)'            ? bikeSidewalkOrder.filter(l=>catMap.has(canon(l))) :
      variable==='Age_limit'                              ? ageLimitOrder.filter(l=>catMap.has(canon(l))) :
      variable==='Helmet_Law(BIKE)'                       ? helmetBikeOrder.filter(l=>catMap.has(canon(l))) :
      variable==='specific_equipment_requirements(BIKE)'  ? equipmentOrder.filter(l=>catMap.has(canon(l))) :
      variable==='Access(BIKE)'                           ? accessBikeOrder.filter(l=>catMap.has(canon(l))) :
      Array.from(catMap.values()).sort();

    div.innerHTML=ordered.map(cat=>`<i style="background:${getColor(cat,variable)}"></i> ${cat}`).join('<br>');
    return div;
  };
  currentLegend.addTo(map);
}

/* ===== POPUPS ===== */
function bindPopup(layer){
  const st=layer.feature.properties.name;
  let val=dataLookup[st]?.[currentVariable]||'N/A';
  if(currentVariable==='Age_limit'&&canon(val)=='mode not defined') val='Regulated at local level';
  if(currentVariable==='Motor_Vehicle_passing_distance(BIKE)'){
    const c=canon(val);
    if(c==='3 ft for under 35mph, 6ft for over') val='Speed-based (3 or 6 ft)';
    else if(c.startsWith('adjacent lane')) val='Adjacent lane';
    else if(c.startsWith('safe')) val='Safe distance';
  }
  const label=modeVariables[currentMode].find(v=>v.value===currentVariable)?.label||currentVariable;
  layer.bindPopup(`<b>${st}</b><br><strong>Mode:</strong> ${currentMode}<br><strong>Variable:</strong> ${label}<br><strong>Category:</strong> ${val}`);
}
function updatePopups(){geojsonLayer.eachLayer(bindPopup);}

/* ===== CITY MARKERS (unchanged) ===== */
const cities=[{name:'Atlanta, GA',coords:[33.749,-84.388]},{name:'Washington, D.C.',coords:[38.9072,-77.0369]}]; // truncated for brevity
const cityMarkers={},btn=document.getElementById('toggle-city-list');let visible=true;
cities.forEach(c=>cityMarkers[c.name]=L.marker(c.coords).addTo(map).bindPopup(`<strong>${c.name}</strong>`));
btn.addEventListener('click',()=>{
  document.getElementById('city-list').style.display=document.getElementById('city-list').style.display==='none'?'block':'none';
  visible=!visible;Object.values(cityMarkers).forEach(m=>visible?m.addTo(map):map.removeLayer(m));
});
</script>
</body>
</html>
