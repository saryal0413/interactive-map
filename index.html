<!DOCTYPE html>
<html>
<head>
  <title>Micromobility Policy Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      color: #142b59;
    }
    #map-wrapper {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 95%;
      margin: 0 auto;
      padding: 10px;
      border: 5px solid #ccc;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      background-color: white;
    }
    .info.legend {
      background: #142b59;
      color: #ffffff;
      padding: 12px 16px;
      font: 16px/20px Arial, sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      border-radius: 8px;
      max-width: 90vw;
    }
    .info.legend i {
      width: 20px;
      height: 20px;
      display: inline-block;
      margin-right: 10px;
      margin-bottom: 5px;
      vertical-align: middle;
      border-radius: 3px;
    }
    @media (max-width: 600px) {
      .info.legend {
        font: 14px/18px Arial, sans-serif;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>

<div id="map-wrapper">

  <div style="text-align: center; font-size: 30px; font-weight: bold; margin-bottom: 10px;">
    Micromobility Regulations in the U.S.
  </div>

  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding: 10px 20px;">
    <img src="logo-funder.jpg" alt="Funder Logo" style="height: 80px; width: 200px;">
    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
      <div style="border: 2px solid #ccc; padding: 12px; background-color: #fafafa; width: 250px;">
        <label for="mode-select">Mode</label>
        <select id="mode-select" style="width: 100%;">
          <option value="E-bike">E-bike</option>
          <option value="E-scooter">E-scooter</option>
        </select>
      </div>
      <div style="border: 2px solid #ccc; padding: 12px; background-color: #fafafa; width: 250px;">
        <label for="variable-select">Variable</label>
        <select id="variable-select" style="width: 100%;"></select>
      </div>
    </div>
    <img src="logo-UTK.png" alt="UTK Logo" style="height: 95px; width: 200px;">
  </div>

  <div style="text-align: center; margin-bottom: 10px;">
    <button id="toggle-city-list" style="background-color: #142b59; color: white; padding: 8px 16px; border: none; border-radius: 5px;">
      Show/Hide City List
    </button>
  </div>

  <div id="city-list" style="display: none; text-align: center; margin-bottom: 10px; font-size: 16px;">
    Click markers on the map to view city regulations.
  </div>

  <div id="map" style="flex-grow: 1; min-height: 60vh;"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="us-states.js"></script>

<script>
const modeVariables = {
  'E-bike': [
    { value: 'Age_Class3_(E-Bike)', label: 'Age Requirement (Class 3)' },
    { value: 'Helmet_Grouped_(E-Bike)', label: 'Helmet Requirement' },
    { value: 'Sidewalk_Riding_(E-Bike)', label: 'Sidewalk Riding' }
  ],
  'E-scooter': [
    { value: 'License_Req_Grouped', label: 'Driver’s License Requirement' }
  ]
};

const map = L.map('map').setView([37.8, -96], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let dataLookup = {}, geojsonLayer, currentLegend;

fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQrQxPEts8ty9L0LPKEw7kD80wc0ZygZrSM57kYHTkgAcvHR6-1qQ2Y3OV70-bcYv4ZuXVsdsWx88GB/pub?output=csv')
  .then(response => response.text())
  .then(csv => {
    const data = Papa.parse(csv, { header: true }).data;
    data.forEach(row => dataLookup[row.State] = row);
    geojsonLayer = L.geoJson(statesData, {
      style: f => getStyle(f, 'Age_Class3_(E-Bike)'),
      onEachFeature: (feature, layer) => {
        const state = feature.properties.name;
        const row = dataLookup[state];
        if (row) {
          const popup = `
            <b>${state}</b><br><br>
            <strong>Helmet:</strong> ${row["Helmet_requirement_(Text)_(E-Bike)"] || 'N/A'}<br>
            <strong>Sidewalk:</strong> ${row["Sidewalk_restrictions_(E-Bike)"] || 'N/A'}<br>
            <strong>License (E-scooter):</strong> ${row["License_Requirement"] || 'N/A'}<br><br>
            <a href="${row.PDF_URL}" target="_blank">View PDF</a>`;
          layer.bindPopup(popup);
        }
      }
    }).addTo(map);
    updateVariableDropdown('E-bike');
    updateLegend('Age_Class3_(E-Bike)');
  });

document.getElementById('mode-select').addEventListener('change', function () {
  updateVariableDropdown(this.value);
});

document.getElementById('variable-select').addEventListener('change', function () {
  const v = this.value;
  geojsonLayer.setStyle(f => getStyle(f, v));
  updateLegend(v);
});

function updateVariableDropdown(mode) {
  const select = document.getElementById('variable-select');
  select.innerHTML = '';
  if (!modeVariables[mode].length) {
    const opt = document.createElement('option');
    opt.textContent = 'No variables available';
    select.appendChild(opt);
    select.disabled = true;
  } else {
    modeVariables[mode].forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.value;
      opt.textContent = item.label;
      select.appendChild(opt);
    });
    select.disabled = false;
    const first = modeVariables[mode][0].value;
    geojsonLayer.setStyle(f => getStyle(f, first));
    updateLegend(first);
  }
}

function getStyle(f, variable) {
  const state = f.properties.name;
  const val = dataLookup[state]?.[variable];
  return {
    fillColor: getColor(val, variable),
    weight: 1,
    color: 'white',
    fillOpacity: 0.7
  };
}

function getColor(value, variable) {
  if (!value || value === 'NA') return '#d3d3d3';
  if (variable === 'Age_Class3_(E-Bike)') {
    if (value === 'None') return '#ffffb2';
    const v = parseInt(value);
    if (!isNaN(v)) return v >= 16 ? '#1a9641' : '#fdae61';
  }
  if (variable === 'Helmet_Grouped_(E-Bike)') {
    if (value === 'Under_18') return '#3288bd';
    if (value === 'Under_16') return '#66c2a5';
    if (value === 'No') return '#fdae61';
  }
  if (variable === 'Sidewalk_Riding_(E-Bike)') {
    const map = {
      'Can ride': '#1a9641',
      'Cannot ride': '#d7191c',
      'Partial allowed': '#fdae61',
      'Cannot ride certain classes': '#984ea3',
      'Cannot ride but can stand and park': '#377eb8'
    };
    return map[value] || '#ccc';
  }
  if (variable === 'License_Req_Grouped') {
    if (value === 'DL not required') return '#1a9641';
    if (value === 'DL required') return '#d7191c';
    if (value === 'DL or permit required') return '#fdae61';
    if (value === 'Mode not defined') return '#d3d3d3';
    if (value === 'Check this one') return '#984ea3';
  }
  return '#ccc';
}

function updateLegend(variable) {
  if (currentLegend) map.removeControl(currentLegend);
  currentLegend = L.control({ position: 'bottomright' });
  currentLegend.onAdd = function () {
    const div = L.DomUtil.create('div', 'info legend');
    let labels = [];
    if (variable === 'License_Req_Grouped') {
      const cats = ['DL not required', 'DL required', 'DL or permit required', 'Mode not defined', 'Check this one'];
      const labelsMap = {
        'DL not required': 'No license required',
        'DL required': 'Driver’s license required',
        'DL or permit required': 'DL, permit, or ID',
        'Mode not defined': 'Mode not defined',
        'Check this one': 'Needs check'
      };
      labels = cats.map(cat => `<i style="background:${getColor(cat, variable)}"></i> ${labelsMap[cat]}`);
    }
    div.innerHTML = labels.join('<br>');
    return div;
  };
  currentLegend.addTo(map);
}

const cities = {
  'Atlanta, GA': [33.7490, -84.3880],
  'Austin, TX': [30.2672, -97.7431],
  'Seattle, WA': [47.6062, -122.3321]
};
const cityMarkers = {};
for (const [name, coords] of Object.entries(cities)) {
  const marker = L.marker(coords).bindPopup(`<strong>${name}</strong><br>City-specific data here`);
  marker.addTo(map);
  cityMarkers[name] = marker;
}
let cityMarkersVisible = true;
document.getElementById('toggle-city-list').addEventListener('click', () => {
  const list = document.getElementById('city-list');
  list.style.display = list.style.display === 'none' ? 'block' : 'none';
  cityMarkersVisible = !cityMarkersVisible;
  for (const marker of Object.values(cityMarkers)) {
    if (cityMarkersVisible) marker.addTo(map);
    else map.removeLayer(marker);
  }
});
</script>
</body>
</html>
